---
title: Modelling Spatial Data in R
date: "`r Sys.Date()`"
author: "Tim Newbold"
output:
  rmdformats::downcute:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: true
---

# Overview

In this session, we will explore some of the basic options available for modelling spatial data in R. Given the vast number of methods available for spatial modelling, we will only be able to scratch the surface in this session. However, the tutorial will hopefully give you some insights into the necessity we often face of dealing with space in our models, some of the complexities of constructing spatial models, and some pointers towards commonly used methods you might encounter.

# Further Reading

# Dataset and Non-spatial Models

For this tutorial, we will return to the dataset on beetle biodiversity that we created during the <a href="./SpatialData.html">tutorial</a> on spatial data processing, but first we load the R packages that we will be working with this session.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
library(dplyr)
library(ggplot2)
library(spdep)
library(spatialreg)
library(INLA)
```

You can load the beetles dataset using the following code.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
url("https://www.dropbox.com/scl/fi/4olcttgagt0sd92hg64vk/Ewers2007BeetleData.rds?rlkey=14c8qby2023lt9924bi3th0ee&dl=1") %>%
  readRDS() -> beetles
```

As a reminder, this dataset contains samples of beetle species richness at sites in New Zealand. Sites were sampled either in natural forest (primary vegetation) or in livestock pastures. In the <a href="./">session</a> on spatial data, we added estimates of the proportion of natural habitat in the 5 kilometres surrounding each site.

We will start with a simple model of species richness as a function of the interaction between land use and the proportion of natural habitat in the surrounding landscape.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
m1 <- glm(data = beetles,
          formula = Species_richness~LandUse+NaturalHabitat5k+
            LandUse:NaturalHabitat5k,
          family="poisson")
```

If we inspect the model summary, it appears that beetle species richness is significantly lower in pasture compared to primary vegetation, that there is a weak negative relationship between surrounding natural habitat and species richness in primary vegetation, but that this relationship with surrounding natural habitat is significantly more positive in pastures than in primary vegetation.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
summary(m1)
```

Plotting the predictions from this model on a graph seems to support this conclusion.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
preds <- predict(object = m1,se.fit = TRUE)

beetles$PredLM <- exp(preds$fit)
beetles$PredLMLower <- exp(preds$fit - 1.96 * preds$se.fit)
beetles$PredLMUpper <- exp(preds$fit + 1.96 * preds$se.fit)

p <- ggplot(data = beetles) + 
  geom_point(mapping = aes(x = NaturalHabitat5k,y = Species_richness,
                           colour = LandUse)) + 
  geom_line(mapping = aes(x = NaturalHabitat5k,y = PredLM,
                          colour = LandUse)) + 
  geom_ribbon(mapping = aes(x = NaturalHabitat5k,
                            ymin = PredLMLower,ymax = PredLMUpper,
                            fill = LandUse),
              alpha = 0.2) + 
  theme_classic()

p
```

However, we need to consider that the data we are analyzing are drawn from a spatially structured survey of sites. In spatial ecological data it is common to detect positive spatial autocorrelation in our response variable, and thus in the residuals of a simple model of the data. When data are positively spatially autocorrelated, it means that values sampled nearby tend to be more similar to each other than values sampled further apart. Positive spatial autocorrelation in ecological data occurs for a number of reasons. One key reason is that nearby ecosystems may be connected by dispersal of organisms between them. A second main reason is that the environment itself is spatially structured, such that environmental conditions tend to be more similar for nearby locations and less similar for locations further apart, all else being equal. Residual spatial autocorrelation can also occur if we have omitted an important spatially structured variable from our analysis.

# Testing for Spatial Autocorrelation

Given the issues outlined above, before concluding a certain set of results from our model, we should first test for residual spatial autocorrelation. We can do this using something called a Moran test, for which we can use the _moran.test_ function in the _spdep_ package. But first we need to convert the spatial coordinates of our sampled data into a list of location neighbours, and then convert these into spatial weights. We complete these steps using the _tri2nb_ and _nb2listw_ functions, both also in the _spdep_ package.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
nb1 <- tri2nb(coords = beetles[,c('Longitude','Latitude')])
sw1 <- nb2listw(neighbours = nb1,style = "W")
mt1 <- moran.test(x = residuals(m1),listw = sw1)

mt1
```

Inspecting the results of the Moran test reveals that we have strong and significant positive spatial autocorrelation in the residuals of our simple generalized linear model.

To make a nice visualization of spatial autocorrelation in our data and models, we can use Moran's plot.

We will start by showing spatial autocorrelation in our response variable (species richness). The _moran.plot_ function generates a data frame with, among other things, the raw values of the specified variable (here species richness), labelled _x_ in the data frame, and a spatially weighted average of the variable at neighbouring locations.

We will plot points identified as influential, in the _is_inf_ column, as large diamonds, and label them with the corresponding row number from the original dataset.

We will add a trend line to show any correlation between raw values and neighbouring values. The positive relationship that we observe here indicates the presence of positive spatial autocorrelation. In other words, smaller values of species richness tend to be associated with smaller values in neighbouring locations, while larger values tend to be associated with larger values in neighbouring locations. 

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
mp <- moran.plot(x = beetles$Species_richness,listw = sw1,plot = FALSE)

p <- ggplot(data = mp,mapping = aes(x = x,y = wx)) + 
  geom_point(shape = 16) + 
  geom_smooth(formula = y~x, method="lm",colour="#5DA899",fill="#5DA899") + 
  geom_hline(yintercept=mean(mp$wx), lty=2) + 
  geom_vline(xintercept=mean(mp$x), lty=2) + 
  geom_point(data=mp[mp$is_inf,], aes(x=x, y=wx), shape=18,size=4) + 
  geom_text(data=mp[mp$is_inf,], aes(x=x, y=wx, label=labels, vjust=1.5)) + 
  scale_x_continuous(name = "Species Richness") + 
  scale_y_continuous(name = "Weighted Avg. Neighbour Species Richness") + 
  theme_classic()

p
```

We can produce the same plot but for the residuals of our simple non-spatial model.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
mp <- moran.plot(x = residuals(m1),listw = sw1,plot = FALSE)

p <- ggplot(data = mp,mapping = aes(x = x,y = wx)) + 
  geom_point(shape = 16) + 
  geom_smooth(formula = y~x, method="lm",colour="#5DA899",fill="#5DA899") + 
  geom_hline(yintercept=mean(mp$wx), lty=2) + 
  geom_vline(xintercept=mean(mp$x), lty=2) + 
  geom_point(data=mp[mp$is_inf,], aes(x=x, y=wx), shape=18,size=4) + 
  geom_text(data=mp[mp$is_inf,], aes(x=x, y=wx, label=labels, vjust=1.5)) + 
  scale_x_continuous(name = "Model Residuals") + 
  scale_y_continuous(name = "Weighted Avg. Neighbour Model Residual") + 
  theme_classic()

p
```

# Accounting for Spatial Dependency - Spatial Autoregression

## Running Spatial Autoregressive Models

The existence of positive spatial autocorrelation in the residuals of our model indicates that we have spatial dependency in our data. I.e., the values that we are recording at one location depend on the values recorded in nearby locations. This violates the assumption of independence of data points made by standard parametric statistical tests. Even if we are not using classical statistical tests, the existence of spatial structure in the data may bias the results of our analyses.

Therefore, to make robust inferences with our data, we need some way of accounting for the spatial dependency in the data. One simple way of doing this is to use spatial autoregression, with a number of functions to do this provided in the _spatialreg_ package.

We have a two key decisions to make in running a spatial autoregressive model:

1. Whether to inclucde a spatially lagged term just for the response variable (simple spatial autoregression) or for both the response and explanatory variables (spatial Durbin model).
2. Whether to fit a spatial autoregressive component (which describes the dependency of values at one location on the values of nearby locations) for just the model error, for just the response variable, or for both the response variable and the model error.

Let's try all combinations of these options, and compare model fit. 

These spatial autoregressive models are an adaptation of linear models, and so can't handle data drawn from a Poisson distribution. Therefore, we will have to log-transform species richness prior to analysis. As discussed in the session on generalized linear modelling, these is not ideal practice, but is unavoidable at the moment.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
beetles$LogRichness <- log(beetles$Species_richness)

# Spatial dependence in model error only
m1.spat.sar.err <- spatialreg::errorsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,
  listw = sw1)
m1.spat.sar.err.d <- spatialreg::errorsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,
  listw = sw1,Durbin = TRUE)
# Spatial dependence in the response variable only
m1.spat.sar.lag <- spatialreg::lagsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,listw = sw1)
m1.spat.sar.lag.d <- spatialreg::lagsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,listw = sw1,Durbin = TRUE)
# Spatial dependence in the model error and response variable
m1.spat.sar.sac <- spatialreg::sacsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,listw = sw1)
m1.spat.sar.sac.d <- spatialreg::sacsarlm(
  data = beetles,formula = LogRichness~LandUse+NaturalHabitat5k+
    LandUse:NaturalHabitat5k,listw = sw1,Durbin = TRUE)
```

## Comparing Spatial Autoregressive Models

We can first compare the AIC values of these models to see which appears to fit the data most parsimoniously.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
AIC(m1.spat.sar.err,m1.spat.sar.err.d,
    m1.spat.sar.lag,m1.spat.sar.lag.d,
    m1.spat.sar.sac,m1.spat.sar.sac.d)
```

This seems to suggest that the simplest model, which accounts for spatial autoregression just in the model error, and includes a spatial lag term just for the model response variable, not also the explanatory variables, is the best fitting one.

But let's also see whether these models have been successful in removing residual spatial autocorrelation.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
nb <- tri2nb(beetles[,c('Longitude','Latitude')])
w <- nb2listw(neighbours = nb,style = "W")
mt.err <- moran.test(x = residuals(m1.spat.sar.err),listw = w)
mt.err
mt.err.d <- moran.test(x = residuals(m1.spat.sar.err.d),listw = w)
mt.err.d
mt.lag <- moran.test(x = residuals(m1.spat.sar.lag),listw = w)
mt.lag
mt.lag.d <- moran.test(x = residuals(m1.spat.sar.lag.d),listw = w)
mt.lag.d
mt.sac <- moran.test(x = residuals(m1.spat.sar.sac),listw = w)
mt.sac
mt.sac.d <- moran.test(x = residuals(m1.spat.sar.sac.d),listw = w)
mt.sac.d
```

With the exception of one model, there is no longer significant spatial autocorrelation in the residuals of these models, suggesting that they have successfully dealt with the issue of spatial dependency. Based on the AIC values and tests of residual spatial autocorrelation, it would be tempting to choose the simplest model as the final analysis.

If we inspect the summary of this model, we can see that the conclusions of our non-spatial generalized linear model are still supported: there is a significant reduction in beetle species richness in pastures compared to primary vegetation, and a significantly more positive effect of surrounding natural habitat on beetle species richness in pastures compared to primary vegetation.

In this model summary, the _lambda_ statistic describes the strength of spatial autoregression in the model error. For spatial model types that account for spatial autoregression in the model response variable, this is described by the _rho_ statistic.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
summary(m1.spat.sar.err)
```

## Predictions and Plotting with Spatial Autoregressive Models

If we run the built-in prediction function on a spatial autoregression model, we get something rather different than when we make predictions for simple linear regression models or generalized linear models.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
preds.sar.err <- data.frame(predict(m1.spat.sar.err))

head(preds.sar.err)
```

Here, the 'trend' column represents the fitted effect of the explanatory variables (land use and surrounding natural habitat), ignoring the spatial dependency, the 'signal' represents the effect of spatial dependency, and the 'fit' column contains the overall predictions from the model, combining the effects of the explanatory variables with the effect of spatial dependency (i.e., 'trend' + 'signal').

If we plot the overall predictions on a graph, the effect of the spatial dependency means it is hard to discern the response to the explanatory variables. 

To make this plot, we will first rename the columns in the predictions to make sure we can identify them later, and add them to the original dataset.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
names(preds.sar.err) <- c("FitSARErr","TrendSARErr","SignalSARErr")
# Try binding the predictions with the original dataset
# Will fail if this operation has already been run once
try(beetles %>% bind_cols(preds.sar.err,.name_repair = "check_unique") -> beetles)

p <- ggplot(data = beetles,mapping = aes(x = NaturalHabitat5k)) + 
  geom_point(mapping = aes(y = Species_richness,colour=LandUse)) + 
  geom_line(mapping = aes(y = exp(FitSARErr),colour=LandUse),linetype = "dashed") + 
  theme_classic()

p
```

We can also plot the 'trend' column to represent the effect of the explanatory variables, but ignoring spatial dependency. This can yield values that are on a different scale to the original species richness measurements, although not in this case because our model only has an autogressive term for the model error (if you re-run the code, but making predictions with one of the more complex models, you will see what I mean).

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
p <- ggplot(data = beetles,mapping = aes(x = NaturalHabitat5k)) + 
  geom_point(mapping = aes(y = Species_richness,colour=LandUse)) + 
  geom_line(mapping = aes(y = exp(TrendSARErr),colour=LandUse)) + 
  geom_line(mapping = aes(y = exp(FitSARErr),colour=LandUse),linetype = "dashed") + 
  theme_classic()

p
```

Another problem that we have with the predictions from a spatial autoregression is that we don't automatically get an estimate of the uncertainty in our predictions. We can use a work-around, manually calculating the confidence in our model estimates from the model coefficients and the variance-covariance matrix (which gives the uncertainty associated with each coefficient as well as covariance between each pair of coefficients). Although this is the standard approach for obtaining confidence in the estimates made by classical statistical models, it is a bit of a fudge for spatial models (ignoring the spatial component of the model), and so we should treat these uncertainty estimates with some caution!

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
# Obtain the model design matrix (this represents the values of the
# explanatory variables for each row of data)
mm <- model.matrix(formula(m1.spat.sar.err),data = beetles)

# Extract the model coefficients
coefs <- coef(m1.spat.sar.err)

# Remove the 'lambda' coefficient, which gets in the way when we try
# to make predictions
coefs <- coefs[-which(names(coefs)=='lambda')]

# Obtain the variance-covariance matrix from the model
vc <- vcov(m1.spat.sar.err)

# Remove rows and columns associated with the 'lambda' parameter, which again
# cause problems when making predictions
vc <- vc[-which(rownames(vc)=='lambda'),]
vc <- vc[,-which(colnames(vc)=='lambda')]

# Multiply the model design matrix by the model-estimated coefficients to
# obtain the predicted values (these are the same as the 'trend' estimates
# we obtained earlier with the predict function)
pred <- mm %*% coefs

# Obtain standard error around the predictions from the variance-covariance matrix
se_pred <- sqrt(diag(mm %*% vc %*% t(mm)))

# Add the predictions and confidence intervals to the original data frame
beetles$PredSARErr <- exp(pred)
beetles$PredSARErrLwr <- exp(pred - 1.96 * se_pred)
beetles$PredSARErrUpr <- exp(pred + 1.96 * se_pred)


p <- ggplot(data = beetles,mapping = aes(x = NaturalHabitat5k)) + 
  geom_point(mapping = aes(y = Species_richness,colour=LandUse)) + 
  geom_line(mapping = aes(y = PredSARErr,colour=LandUse)) + 
  geom_ribbon(mapping = aes(ymin = PredSARErrLwr,ymax = PredSARErrUpr,
                            fill=LandUse),alpha=0.2) + 
  theme_classic()

p


```

# Accounting for Spatial Dependency - INLA Models

In the final section of the tutorial, we will work with a powerful, flexible and very fast-running set of Bayesian methods for developing models with spatial dependency, using the _INLA_ package, which uses Integrated Nested Laplace Approximation to find parameter values.

We will only here scratch the surface of what these models can do. If you want to find out more, this [website](https://www.r-inla.org/) has a lot of useful materials.

We will here run a conditional autoregressive Besag model to capture the spatial dependency (see this [tutorial](https://codingclubuc3m.rbind.io/post/2019-11-05/) for further details).

We first need to define the neighbourhood of sampled locations again, and now convert this to an INLA graph object. We also need to create a variable that identifies each row in the data, for linking to the spatial neighbourhoods object.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
nb <- tri2nb(coords = beetles[,c('Longitude','Latitude')])
nb.mat <- nb2mat(neighbours = nb,style = "B",zero.policy = TRUE)
nb.graph <- inla.read.graph(nb.mat)

beetles$ID <- 1:nrow(beetles)
```

We can now create our model formula, which contains the standard formulation for relating species richness to land use and natural habitat, as well as the spatial dependency component, which specifies a Besag model.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
mod.formula <- Species_richness~LandUse+NaturalHabitat5k+LandUse:NaturalHabitat5k+
  f(ID, model="besag",graph = nb.graph)
```

Now, we can run our INLA model. We need to specify that we want to return the model correlation matrix, which allows us to extract the variances and covariances of the model parameters, for plotting uncertainty.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
m1.spat.inla <- inla(formula = mod.formula,family = "poisson",
                     data = beetles,
                     control.fixed = list(correlation.matrix=TRUE))
```

Inspecting the summary of this model, you can see the coefficient estimates (with uncertainty). These values should now hopefully be at least somewhat familiar.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
summary(m1.spat.inla)
```

We can plot the model-estimated effects of land use and natural habitat from this model in a very similar way as for the simple spatial autoregressive models we used earlier.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
coefs <- m1.spat.inla$summary.fixed$mean
names(coefs) <- m1.spat.inla$names.fixed

vc <- m1.spat.inla$misc$lincomb.derived.covariance.matrix

pred <- mm %*% coefs

se_pred <- sqrt(diag(mm %*% vc %*% t(mm)))

beetles$PredINLA <- exp(pred)
beetles$PredINLALower <- exp(pred - 1.96 * se_pred)
beetles$PredINLAUpper <- exp(pred + 1.96 * se_pred)

beetles$FittedINLA <- m1.spat.inla$summary.fitted.values$mean

p <- ggplot(data = beetles) + 
  geom_point(mapping = aes(x = NaturalHabitat5k,y = Species_richness,
                           colour = LandUse)) +
  geom_line(mapping = aes(x = NaturalHabitat5k,y = FittedINLA,
                          colour = LandUse),linetype = 2,alpha = 0.7) + 
  geom_line(mapping = aes(x = NaturalHabitat5k,y = PredINLA,
                          colour = LandUse)) +
  geom_ribbon(mapping = aes(x = NaturalHabitat5k,
                            ymin = PredINLALower,ymax = PredINLAUpper,
                            fill = LandUse),
              alpha = 0.2) +
  theme_classic()

p
```

Finally, let's run a Moran test to assess the spatial autocorrelation in the residuals of this INLA model. This test shows that there is no significant residual spatial autocorrelation with this model.

```{r, echo=TRUE,results=TRUE,message=FALSE,warning=FALSE}
inla.resids <- beetles$LogRichness - log(beetles$FittedINLA)

nb <- tri2nb(beetles[,c('Longitude','Latitude')])
w <- nb2listw(neighbours = nb,style = "W")
mt <- moran.test(x = inla.resids,listw = w)

mt
```

# Exercises

<div style="background-color: #f0f0f0; color: black; padding: 15px; border: none;">
Download a dataset that describes recorded mammal species richness across Egypt:
url("https://www.dropbox.com/scl/fi/hy5zlgtav7mguncqs9i0h/EgyptMammalSpeciesRichness.rds?rlkey=vavnb7d0appd16q1d14tkau46&dl=1") %>% readRDS -> EgyptMammalSpeciesRichness

The columns in this dataset describe recorded mammal species richness (SpRich), annual mean temperature (AnnualTemp), total annual precipitation (AnnualPrecip), as well as the Longitude and Latitude spatial coordinates.

Try making some simple generalized linear models of species richness as a function of the climate variables. Then, test for spatial autocorrelation, and try out some of the spatial modelling techniques we have learned in the preceding tutorial.
</div>